<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ModRoller.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">craftingtool</a> &gt; <a href="index.source.html" class="el_package">com.jomi.Util</a> &gt; <span class="el_source">ModRoller.java</span></div><h1>ModRoller.java</h1><pre class="source lang-java linenums"><span class="fc" id="L1">package com.jomi.Util;</span>

import java.util.List;
import java.util.Random;

import com.jomi.Handlers.Init.modifiers.Mod;
import com.jomi.Handlers.Init.modifiers.ModTier;
import com.jomi.Handlers.registry.ModRegistry;

<span class="nc" id="L10">public class ModRoller {</span>

    // ------------------------------------------------------------
    // RolledMod: represents a chosen tier of a mod (no stat rolling)
    // ------------------------------------------------------------
    public record RolledMod(
        String modId,
        String name,
        List&lt;String&gt; tags,
        ModTier tier
    ) {

<span class="fc" id="L22">        public RolledMod {</span>
<span class="fc" id="L23">            tags = List.copyOf(tags);</span>
<span class="fc" id="L24">        }</span>

        public int ilvl() {
<span class="nc" id="L27">            return tier.ilvl();</span>
        }

        @Override
        public String toString() {
<span class="nc" id="L32">            return &quot;RolledMod{ id=&quot; + modId +</span>
<span class="nc" id="L33">                &quot;, name=&quot; + name +</span>
<span class="nc" id="L34">                &quot;, tags=&quot; + tags +</span>
<span class="nc" id="L35">                &quot;, tier=&quot; + tier.tier() +</span>
<span class="nc" id="L36">                &quot;, stats=&quot; + tier.stats() +</span>
                &quot; }&quot;;
        }
    }


    // ------------------------------------------------------------
    // ModType: used for random rolling
    // ------------------------------------------------------------
<span class="fc" id="L45">    public enum ModType {</span>
<span class="fc" id="L46">        PREFIX,</span>
<span class="fc" id="L47">        SUFFIX,</span>
<span class="fc" id="L48">        BOTH</span>
    }

<span class="fc" id="L51">    private static final Random random = new Random();</span>


    // ------------------------------------------------------------
    // NEW: Create a RolledMod from a Mod definition + item level
    // ------------------------------------------------------------
    public static RolledMod fromMod(Mod mod, int itemLevel) {

        // Pick the highest tier allowed by item level
<span class="nc" id="L60">        ModTier tier = mod.tiers().stream()</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">            .filter(t -&gt; t.ilvl() &lt;= itemLevel)</span>
<span class="nc" id="L62">            .sorted((a, b) -&gt; Integer.compare(b.tier(), a.tier())) // highest tier first</span>
<span class="nc" id="L63">            .findFirst()</span>
<span class="nc" id="L64">            .orElseThrow(() -&gt; new IllegalStateException(</span>
<span class="nc" id="L65">                &quot;No valid tier for mod &quot; + mod.id() + &quot; at ilvl &quot; + itemLevel</span>
<span class="nc" id="L66">            ));</span>

<span class="nc" id="L68">        return new RolledMod(</span>
<span class="nc" id="L69">            mod.id(),</span>
<span class="nc" id="L70">            mod.name(),</span>
<span class="nc" id="L71">            mod.tags(),</span>
<span class="nc" id="L72">            tier</span>
        );
    }


    // ------------------------------------------------------------
    // Existing: Weighted random mod roller
    // ------------------------------------------------------------
    public static RolledMod rollRandomTier(String itemClass, int itemLevel, ModType type) {

<span class="fc" id="L82">        var mods = ModRegistry.getItemByClass(itemClass);</span>
<span class="pc bpc" id="L83" title="2 of 4 branches missed.">        if (mods == null || mods.isEmpty()) {</span>
<span class="nc" id="L84">            throw new IllegalArgumentException(&quot;No mods registered for itemClass: &quot; + itemClass);</span>
        }

<span class="fc" id="L87">        var filteredMods = mods.stream()</span>
<span class="pc bpc" id="L88" title="1 of 3 branches missed.">            .filter(mod -&gt; switch (type) {</span>
<span class="fc" id="L89">                case PREFIX -&gt; mod.prefix();</span>
<span class="fc" id="L90">                case SUFFIX -&gt; mod.suffix();</span>
<span class="nc" id="L91">                case BOTH   -&gt; true;</span>
<span class="fc" id="L92">            })</span>
<span class="fc" id="L93">            .toList();</span>

<span class="fc bfc" id="L95" title="All 2 branches covered.">        if (filteredMods.isEmpty()) {</span>
<span class="fc" id="L96">            throw new IllegalStateException(&quot;No mods of type &quot; + type + &quot; for itemClass &quot; + itemClass);</span>
        }

        record Entry (Mod mod, ModTier tier) { }

<span class="fc" id="L101">        var entries = filteredMods.stream()</span>
<span class="fc" id="L102">            .flatMap(mod -&gt; mod.tiers().stream()</span>
<span class="fc bfc" id="L103" title="All 2 branches covered.">                .filter(tier -&gt; tier.ilvl() &lt;= itemLevel)</span>
<span class="fc" id="L104">                .map(tier -&gt; new Entry(mod, tier)))</span>
<span class="fc" id="L105">            .toList();</span>

<span class="pc bpc" id="L107" title="1 of 2 branches missed.">        if (entries.isEmpty()) {</span>
<span class="nc" id="L108">            throw new IllegalStateException(</span>
<span class="nc" id="L109">                &quot;No eligible tiers for itemClass &quot; + itemClass +</span>
<span class="nc" id="L110">                &quot; at item level &quot; + itemLevel +</span>
<span class="nc" id="L111">                &quot; for type &quot; + type</span>
            );
        }

<span class="fc" id="L115">        int totalWeight = entries.stream()</span>
<span class="fc" id="L116">            .mapToInt(e -&gt; e.tier.weight())</span>
<span class="fc" id="L117">            .sum();</span>

<span class="fc" id="L119">        int roll = random.nextInt(totalWeight);</span>

<span class="pc bpc" id="L121" title="1 of 2 branches missed.">        for (Entry e : entries) {</span>
<span class="fc" id="L122">            roll -= e.tier.weight();</span>
<span class="fc bfc" id="L123" title="All 2 branches covered.">            if (roll &lt; 0) {</span>
<span class="fc" id="L124">                return new RolledMod(</span>
<span class="fc" id="L125">                    e.mod.id(),</span>
<span class="fc" id="L126">                    e.mod.name(),</span>
<span class="fc" id="L127">                    e.mod.tags(),</span>
<span class="fc" id="L128">                    e.tier</span>
                );
            }
        }

<span class="nc" id="L133">        throw new IllegalStateException(&quot;Weighted roll failed for itemClass: &quot; + itemClass);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>