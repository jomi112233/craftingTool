<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StartNode.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">craftingtool</a> &gt; <a href="index.source.html" class="el_package">com.jomi.GUI.simlatorParts.Nodes</a> &gt; <span class="el_source">StartNode.java</span></div><h1>StartNode.java</h1><pre class="source lang-java linenums">package com.jomi.GUI.simlatorParts.Nodes;

import java.util.ArrayList;
import java.util.List;

import com.jomi.App;
import com.jomi.GUI.simlatorParts.baseNode.NodeSection;
import com.jomi.GUI.simlatorParts.baseNode.NodeView;
import com.jomi.Handlers.Init.modifiers.Mod;
import com.jomi.Handlers.Init.modifiers.ModTier;
import com.jomi.Handlers.Init.project.Node;
import com.jomi.Handlers.Init.project.Project;
import com.jomi.Handlers.Item.LoadedItem;
import com.jomi.Handlers.registry.ModRegistry;
import com.jomi.Util.ModRoller;
import com.jomi.Util.ModRoller.RolledMod;
import com.jomi.Util.NodeShit.searchAction;
import com.jomi.Util.NodeShit.Modifier.NodeEditorWindow;

public class StartNode extends NodeView {

    private final LoadedItem item;
    private List&lt;NodeSection&gt; sections;

    public StartNode(Node node, Project project) {
<span class="nc" id="L26">        super(node, project);</span>

<span class="nc" id="L28">        this.item = project.getBaseItem();</span>
<span class="nc" id="L29">        buildSections();</span>

<span class="nc" id="L31">        setTitle(extractClassName(item.getLoadedItemClass()));</span>
<span class="nc" id="L32">        setInfo(String.valueOf(item.getItemLevel()));</span>
         
<span class="nc" id="L34">    }</span>

    // ---------------------------------------------------------
    // BUILD SECTIONS
    // ---------------------------------------------------------
    private void buildSections() {

<span class="nc" id="L41">        List&lt;String&gt; prefixItems = new ArrayList&lt;&gt;(</span>
<span class="nc" id="L42">                item.getPrefix().stream()</span>
<span class="nc" id="L43">                        .map(this::formatMod)</span>
<span class="nc" id="L44">                        .toList()</span>
        );
<span class="nc" id="L46">        prefixItems.add(&quot;add&quot;);</span>

<span class="nc" id="L48">        List&lt;String&gt; suffixItems = new ArrayList&lt;&gt;(</span>
<span class="nc" id="L49">                item.getSuffix().stream()</span>
<span class="nc" id="L50">                        .map(this::formatMod)</span>
<span class="nc" id="L51">                        .toList()</span>
        );
<span class="nc" id="L53">        suffixItems.add(&quot;add&quot;);</span>

<span class="nc" id="L55">        sections = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L56">        sections.add(new NodeSection(&quot;Prefix&quot;, prefixItems));</span>
<span class="nc" id="L57">        sections.add(new NodeSection(&quot;Suffix&quot;, suffixItems));</span>
<span class="nc" id="L58">    }</span>

    @Override
    protected List&lt;NodeSection&gt; getSections() {
<span class="nc" id="L62">        return sections;</span>
    }

    // ---------------------------------------------------------
    // SEARCH RESULT SELECTED
    // ---------------------------------------------------------
    @Override
    protected void onSearchResultSelected(String section, String key, String result) {

        // Update UI
<span class="nc" id="L72">        replaceSectionItem(section, &quot;search:&quot; + key, &quot;• &quot; + result);</span>

        // Extract name and tier
<span class="nc" id="L75">        String name = result.substring(0, result.lastIndexOf(&quot;(T&quot;)).trim();</span>
<span class="nc" id="L76">        int tierNum = Integer.parseInt(</span>
<span class="nc" id="L77">                result.substring(result.lastIndexOf(&quot;(T&quot;) + 2, result.lastIndexOf(&quot;)&quot;))</span>
        );

        // Find the mod
<span class="nc" id="L81">        Mod mod = ModRegistry.searchByName(name).stream()</span>
<span class="nc" id="L82">                .findFirst()</span>
<span class="nc" id="L83">                .orElse(null);</span>

<span class="nc bnc" id="L85" title="All 2 branches missed.">        if (mod != null) {</span>

            // Find the specific tier
<span class="nc" id="L88">            ModTier tier = mod.tiers().stream()</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">                    .filter(t -&gt; t.tier() == tierNum)</span>
<span class="nc" id="L90">                    .findFirst()</span>
<span class="nc" id="L91">                    .orElse(null);</span>

<span class="nc bnc" id="L93" title="All 2 branches missed.">            if (tier != null) {</span>

                // Roll EXACT tier
<span class="nc" id="L96">                RolledMod rolled = new RolledMod(mod.id(), mod.name(), mod.tags(), tier);</span>

<span class="nc bnc" id="L98" title="All 2 branches missed.">                if (section.equals(&quot;Prefix&quot;)) {</span>
<span class="nc" id="L99">                    item.getPrefix().add(rolled);</span>
                } else {
<span class="nc" id="L101">                    item.getSuffix().add(rolled);</span>
                }

<span class="nc" id="L104">                getProject().setBaseItem(item);</span>
<span class="nc" id="L105">                getProject().saveBaseItem();</span>
            }
        }

<span class="nc" id="L109">        ensureAddButton(section);</span>
<span class="nc" id="L110">        refresh();</span>
<span class="nc" id="L111">    }</span>

    // ---------------------------------------------------------
    // CLICK HANDLING
    // ---------------------------------------------------------
    @Override
    protected void onSectionItemClicked(String sectionTitle, String itemText) {

<span class="nc" id="L119">        String cleaned = itemText.trim().toLowerCase();</span>

<span class="nc bnc" id="L121" title="All 2 branches missed.">        if (cleaned.equals(&quot;add&quot;)) {</span>
<span class="nc" id="L122">            replaceSectionItem(sectionTitle, itemText, &quot;search:&quot; + sectionTitle.toLowerCase());</span>
        } else {
<span class="nc" id="L124">            removeMod(sectionTitle, itemText);</span>
        }

<span class="nc" id="L127">        refresh();</span>
<span class="nc" id="L128">    }</span>

    private void removeMod(String section, String itemText) {

<span class="nc" id="L132">        List&lt;NodeSection&gt; updated = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L134" title="All 2 branches missed.">        for (NodeSection sec : sections) {</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">            if (sec.title().equals(section)) {</span>

<span class="nc" id="L137">                List&lt;String&gt; items = new ArrayList&lt;&gt;(sec.items());</span>

<span class="nc" id="L139">                items.removeIf(i -&gt; i.trim().equalsIgnoreCase(itemText.trim()));</span>

<span class="nc bnc" id="L141" title="All 2 branches missed.">                if (!items.contains(&quot;add&quot;)) {</span>
<span class="nc" id="L142">                    items.add(&quot;add&quot;);</span>
                }

<span class="nc" id="L145">                updated.add(new NodeSection(section, items));</span>
<span class="nc" id="L146">            } else {</span>
<span class="nc" id="L147">                updated.add(sec);</span>
            }
<span class="nc" id="L149">        }</span>

<span class="nc" id="L151">        sections = updated;</span>

<span class="nc" id="L153">        removeFromLoadedItem(section, itemText);</span>
<span class="nc" id="L154">    }</span>

    private void removeFromLoadedItem(String section, String itemText) {
<span class="nc" id="L157">        String cleanedName =</span>
<span class="nc" id="L158">                itemText.replace(&quot;•&quot;, &quot;&quot;)</span>
<span class="nc" id="L159">                        .replaceAll(&quot;\\(T\\d+\\)&quot;, &quot;&quot;)</span>
<span class="nc" id="L160">                        .trim();</span>

<span class="nc bnc" id="L162" title="All 2 branches missed.">        if (section.equals(&quot;Prefix&quot;)) {</span>
<span class="nc" id="L163">            item.getPrefix().removeIf(m -&gt; m.name().equalsIgnoreCase(cleanedName));</span>
        } else {
<span class="nc" id="L165">            item.getSuffix().removeIf(m -&gt; m.name().equalsIgnoreCase(cleanedName));</span>
        }

<span class="nc" id="L168">        getProject().setBaseItem(item);</span>
<span class="nc" id="L169">        getProject().saveBaseItem();</span>
<span class="nc" id="L170">    }</span>

    private void ensureAddButton(String section) {
<span class="nc bnc" id="L173" title="All 2 branches missed.">        for (NodeSection sec : sections) {</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">            if (sec.title().equals(section)) {</span>
<span class="nc" id="L175">                List&lt;String&gt; items = new ArrayList&lt;&gt;(sec.items());</span>

<span class="nc bnc" id="L177" title="All 2 branches missed.">                if (!items.contains(&quot;add&quot;)) {</span>
<span class="nc" id="L178">                    items.add(&quot;add&quot;);</span>
                }

<span class="nc" id="L181">                replaceSection(section, items);</span>
<span class="nc" id="L182">                return;</span>
            }
<span class="nc" id="L184">        }</span>
<span class="nc" id="L185">    }</span>

    private void replaceSection(String section, List&lt;String&gt; newItems) {
<span class="nc" id="L188">        List&lt;NodeSection&gt; updated = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L190" title="All 2 branches missed.">        for (NodeSection sec : sections) {</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">            if (sec.title().equals(section)) {</span>
<span class="nc" id="L192">                updated.add(new NodeSection(section, newItems));</span>
            } else {
<span class="nc" id="L194">                updated.add(sec);</span>
            }
<span class="nc" id="L196">        }</span>

<span class="nc" id="L198">        sections = updated;</span>
<span class="nc" id="L199">    }</span>

    @Override
    public void replaceSectionItem(String section, String oldItem, String newItem) {
<span class="nc" id="L203">        List&lt;NodeSection&gt; updated = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L205" title="All 2 branches missed.">        for (NodeSection sec : sections) {</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">            if (sec.title().equals(section)) {</span>
<span class="nc" id="L207">                List&lt;String&gt; items = new ArrayList&lt;&gt;(sec.items());</span>
<span class="nc" id="L208">                int index = items.indexOf(oldItem);</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">                if (index &gt;= 0) {</span>
<span class="nc" id="L210">                    items.set(index, newItem);</span>
                }
<span class="nc" id="L212">                updated.add(new NodeSection(section, items));</span>
<span class="nc" id="L213">            } else {</span>
<span class="nc" id="L214">                updated.add(sec);</span>
            }
<span class="nc" id="L216">        }</span>

<span class="nc" id="L218">        sections = updated;</span>
<span class="nc" id="L219">    }</span>

    // ---------------------------------------------------------
    // SEARCH SOURCE — EXPAND TIERS
    // ---------------------------------------------------------
    @Override
    protected List&lt;? extends searchAction&gt; getSearchSource(String section, String key) {

<span class="nc" id="L227">        boolean isPrefix = section.equalsIgnoreCase(&quot;Prefix&quot;);</span>
<span class="nc" id="L228">        boolean isSuffix = section.equalsIgnoreCase(&quot;Suffix&quot;);</span>

        // Collect used mod IDs
<span class="nc" id="L231">        var usedMods = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L232">        item.getPrefix().forEach(m -&gt; usedMods.add(m.modId()));</span>
<span class="nc" id="L233">        item.getSuffix().forEach(m -&gt; usedMods.add(m.modId()));</span>

<span class="nc" id="L235">        return ModRegistry.getAll().stream()</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">                .filter(m -&gt; isPrefix ? m.prefix() : m.suffix())</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">                .filter(m -&gt; !usedMods.contains(m.id())) // &lt;-- HIDE ENTIRE MOD</span>
<span class="nc" id="L238">                .flatMap(mod -&gt; mod.tiers().stream()</span>
<span class="nc" id="L239">                        .map(tier -&gt; new TierSearchEntry(mod, tier))</span>
                )
<span class="nc" id="L241">                .toList();</span>
    }


    // ---------------------------------------------------------
    // TIER SEARCH ENTRY
    // ---------------------------------------------------------
<span class="nc" id="L248">    public record TierSearchEntry(Mod mod, ModTier tier) implements searchAction {</span>

        @Override
        public String getName() {
<span class="nc" id="L252">            return mod.getName() + &quot; (T&quot; + tier.tier() + &quot;)&quot;;</span>
        }

        @Override
        public String getid() {
            // unique ID per tier
<span class="nc" id="L258">            return mod.id() + &quot;_T&quot; + tier.tier();</span>
        }
    }


    // ---------------------------------------------------------
    // FORMAT MOD
    // ---------------------------------------------------------
    private String formatMod(RolledMod mod) {
<span class="nc" id="L267">        String[] parts = mod.name().split(&quot;,&quot;, 2);</span>

<span class="nc bnc" id="L269" title="All 2 branches missed.">        if (parts.length == 2) {</span>
<span class="nc" id="L270">            return &quot;• (T&quot; + mod.tier().tier() + &quot;) &quot;</span>
<span class="nc" id="L271">                    + parts[0].trim() + &quot;,\n    &quot;</span>
<span class="nc" id="L272">                    + parts[1].trim();</span>
        }
<span class="nc" id="L274">        return &quot;• (T&quot; + mod.tier().tier() + &quot;) &quot; + mod.name();</span>
    }

    private String extractClassName(String full) {
<span class="nc bnc" id="L278" title="All 2 branches missed.">        if (full == null) return &quot;&quot;;</span>
<span class="nc" id="L279">        int index = full.lastIndexOf('/');</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">        return index &gt;= 0 ? full.substring(index + 1) : full;</span>
    }

    @Override
    public LoadedItem execute(LoadedItem item) {
<span class="nc" id="L285">        return getProject().getBaseItem().copy();</span>
    }

    @Override
    protected void edit() {
<span class="nc" id="L290">        NodeEditorWindow.open(item, () -&gt; {</span>
<span class="nc" id="L291">            getProject().saveBaseItem();</span>
<span class="nc" id="L292">            refresh();</span>
<span class="nc" id="L293">            App.getInstance().getGui().showSimulator();</span>
<span class="nc" id="L294">        }, null);</span>
<span class="nc" id="L295">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>