<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NodeView.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">craftingtool</a> &gt; <a href="index.source.html" class="el_package">com.jomi.GUI.simlatorParts</a> &gt; <span class="el_source">NodeView.java</span></div><h1>NodeView.java</h1><pre class="source lang-java linenums">package com.jomi.GUI.simlatorParts;

import java.util.ArrayList;
import java.util.List;

import com.jomi.App;
import com.jomi.Handlers.Init.project.Connection;
import com.jomi.Handlers.Init.project.Node;
import com.jomi.Handlers.Init.project.Project;
import com.jomi.Handlers.Item.LoadedItem;

import javafx.scene.Cursor;
import javafx.scene.control.Button;
import javafx.scene.control.ContextMenu;
import javafx.scene.control.Label;
import javafx.scene.control.MenuItem;
import javafx.scene.input.MouseButton;
import javafx.scene.layout.HBox;
import javafx.scene.layout.Pane;
import javafx.scene.layout.Priority;
import javafx.scene.layout.Region;
import javafx.scene.layout.StackPane;
import javafx.scene.layout.VBox;
import javafx.scene.paint.Color;
import javafx.scene.shape.Circle;

public abstract class NodeView extends StackPane {
    private final Project project;
    private final Node node;

<span class="nc" id="L31">    private final VBox root = new VBox();</span>
<span class="nc" id="L32">    private final HBox header = new HBox();</span>
<span class="nc" id="L33">    private final VBox body = new VBox();</span>
<span class="nc" id="L34">    private final VBox infoArea = new VBox();</span>
<span class="nc" id="L35">    private final Region spacer1 = new Region();</span>
<span class="nc" id="L36">    private final Region spacer2 = new Region();</span>

<span class="nc" id="L38">    private final Button toggleButton = new Button(&quot;+&quot;);</span>
<span class="nc" id="L39">    private final Label titleLabel = new Label();</span>

    private Circle inputPort;
    private Circle outputPort;

    private double dragOffsetX;
    private double dragOffsetY;

<span class="nc" id="L47">    private boolean expanded = false;</span>


<span class="nc" id="L50">    public NodeView(Node node, Project project) {</span>
<span class="nc" id="L51">        this.node = node;</span>
<span class="nc" id="L52">        this.project = project;</span>

<span class="nc" id="L54">        getStyleClass().add(&quot;node-root&quot;);</span>

<span class="nc" id="L56">        header.getStyleClass().add(&quot;node-header&quot;);</span>

<span class="nc" id="L58">        toggleButton.getStyleClass().add(&quot;node-toggle&quot;);</span>
<span class="nc" id="L59">        toggleButton.setOnAction(e -&gt; toggle());</span>

        //titleLabel.setText(title);
<span class="nc" id="L62">        titleLabel.getStyleClass().add(&quot;node-title&quot;);</span>

<span class="nc" id="L64">        HBox.setHgrow(spacer1, Priority.ALWAYS);</span>
<span class="nc" id="L65">        HBox.setHgrow(spacer2, Priority.ALWAYS);</span>


<span class="nc" id="L68">        header.getChildren().addAll(toggleButton, spacer1, titleLabel, spacer2, infoArea);</span>

<span class="nc" id="L70">        body.getStyleClass().add(&quot;node-body&quot;);</span>
<span class="nc" id="L71">        body.setVisible(false);</span>
<span class="nc" id="L72">        body.setManaged(false);</span>

<span class="nc" id="L74">        root.getChildren().addAll(header, body);</span>
<span class="nc" id="L75">        getChildren().add(root);</span>

<span class="nc" id="L77">        createPorts();</span>

<span class="nc" id="L79">        enableContextMenu();</span>
<span class="nc" id="L80">        enableDragging();</span>
<span class="nc" id="L81">        enablePortConnections();</span>
<span class="nc" id="L82">    }</span>

    private void toggle() {
<span class="nc bnc" id="L85" title="All 2 branches missed.">        expanded = !expanded;</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">        toggleButton.setText(expanded ? &quot;-&quot; : &quot;+&quot;);</span>

<span class="nc" id="L88">        body.setVisible(expanded);</span>
<span class="nc" id="L89">        body.setManaged(expanded);</span>

<span class="nc bnc" id="L91" title="All 2 branches missed.">        if (expanded) {</span>
<span class="nc" id="L92">            body.getChildren().setAll(buildContent());</span>
        }
<span class="nc" id="L94">    }</span>

    protected abstract VBox buildContent();
    
    public Label getTitLabel() {
<span class="nc" id="L99">        return titleLabel;</span>
    }


    private void createPorts() {

        // INPUT PORT
<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (node.getInputPort()) {</span>
<span class="nc" id="L107">            inputPort = new Circle(6, Color.DODGERBLUE);</span>
<span class="nc" id="L108">            inputPort.setCursor(Cursor.HAND);</span>
<span class="nc" id="L109">            inputPort.setPickOnBounds(true);</span>
<span class="nc" id="L110">            inputPort.setMouseTransparent(false);</span>

<span class="nc" id="L112">            inputPort.setOnMousePressed(e -&gt; e.consume());</span>
<span class="nc" id="L113">            inputPort.setOnMouseDragged(e -&gt; e.consume());</span>

<span class="nc" id="L115">            getChildren().add(inputPort);</span>
        }

        // OUTPUT PORT
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (node.getOutputPort()) {</span>
<span class="nc" id="L120">            outputPort = new Circle(6, Color.ORANGE);</span>
<span class="nc" id="L121">            outputPort.setCursor(Cursor.HAND);</span>
<span class="nc" id="L122">            outputPort.setPickOnBounds(true);</span>
<span class="nc" id="L123">            outputPort.setMouseTransparent(false);</span>

<span class="nc" id="L125">            outputPort.setOnMousePressed(e -&gt; e.consume());</span>
<span class="nc" id="L126">            outputPort.setOnMouseDragged(e -&gt; e.consume());</span>

<span class="nc" id="L128">            getChildren().add(outputPort);</span>
        }
<span class="nc" id="L130">    }</span>

    @Override
    protected void layoutChildren() {
<span class="nc" id="L134">        super.layoutChildren();</span>

<span class="nc" id="L136">        double w = getWidth();</span>
<span class="nc" id="L137">        double headerHeight = header.getHeight();</span>
<span class="nc" id="L138">        double y = headerHeight / 2;</span>

<span class="nc bnc" id="L140" title="All 2 branches missed.">        if (inputPort != null) {</span>
<span class="nc" id="L141">            inputPort.setLayoutX(-15);</span>
<span class="nc" id="L142">            inputPort.setLayoutY(y);</span>
        }

<span class="nc bnc" id="L145" title="All 2 branches missed.">        if (outputPort != null) {</span>
<span class="nc" id="L146">            outputPort.setLayoutX(w + 15);</span>
<span class="nc" id="L147">            outputPort.setLayoutY(y);</span>
        }
<span class="nc" id="L149">    }</span>


    private void enableDragging() {
<span class="nc" id="L153">        setOnMousePressed(e -&gt; {</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">            if (e.getButton() != MouseButton.PRIMARY) { return; }</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">            if (e.getTarget() instanceof Circle) { return; }</span>

<span class="nc" id="L157">            dragOffsetX = e.getSceneX() - getLayoutX();</span>
<span class="nc" id="L158">            dragOffsetY = e.getSceneY() - getLayoutY();</span>
<span class="nc" id="L159">        });</span>

<span class="nc" id="L161">        setOnMouseDragged(e -&gt; {</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">            if (e.getButton() != MouseButton.PRIMARY) { </span>
<span class="nc" id="L163">                return;</span>
            }
<span class="nc bnc" id="L165" title="All 2 branches missed.">            if (e.getTarget() instanceof Circle) {</span>
<span class="nc" id="L166">                return;</span>
            }

<span class="nc" id="L169">            double newX = e.getSceneX() - dragOffsetX;</span>
<span class="nc" id="L170">            double newY = e.getSceneY() - dragOffsetY;</span>

<span class="nc" id="L172">            setLayoutX(newX);</span>
<span class="nc" id="L173">            setLayoutY(newY);</span>

<span class="nc" id="L175">            node.setxPos(newX);</span>
<span class="nc" id="L176">            node.setyPos(newY);</span>
<span class="nc" id="L177">        });</span>
<span class="nc" id="L178">    }</span>

    private void enableContextMenu() {
<span class="nc" id="L181">        ContextMenu menu = new ContextMenu();</span>

<span class="nc" id="L183">        MenuItem deleteNodeItem = new MenuItem(&quot;Delete Node&quot;);</span>
<span class="nc" id="L184">        MenuItem editItem = new MenuItem(&quot;Edit Node&quot;);</span>
<span class="nc" id="L185">        MenuItem deleteConnectionItem = new MenuItem(&quot;Delete Connections&quot;);</span>

<span class="nc" id="L187">        editItem.setOnAction(e -&gt; editNodeContent());</span>
<span class="nc" id="L188">        deleteNodeItem.setOnAction(e -&gt; deleteNode());</span>
<span class="nc" id="L189">        deleteConnectionItem.setOnAction(e -&gt; deleteConnections());</span>


<span class="nc" id="L192">        menu.getItems().addAll(editItem, deleteNodeItem, deleteConnectionItem);</span>

<span class="nc" id="L194">        setOnContextMenuRequested(e -&gt; {</span>
<span class="nc" id="L195">            menu.show(this, e.getSceneX(), e.getSceneY());</span>
<span class="nc" id="L196">        });</span>
<span class="nc" id="L197">    }</span>

    private void editNodeContent() {
<span class="nc" id="L200">        System.out.println(&quot;Edit node content: &quot; + node.getId());</span>
<span class="nc" id="L201">        edit();</span>
<span class="nc" id="L202">    }</span>

    protected abstract void edit();

    private void deleteNode() {
<span class="nc" id="L207">        System.out.println(&quot;Delete node: &quot; + node.getId());</span>
<span class="nc" id="L208">        project.removeNodeAndConnection(node);</span>
<span class="nc" id="L209">        App.getInstance().getProjectManager().saveProject(project);</span>
<span class="nc" id="L210">        App.getInstance().getGui().showSimulator();</span>
<span class="nc" id="L211">    }</span>

    private void deleteConnections() {
<span class="nc" id="L214">        System.out.println(&quot;Delete connections for: &quot; + node.getId());</span>
<span class="nc" id="L215">        project.removeConnectionsOf(node);</span>
<span class="nc" id="L216">        App.getInstance().getGui().showSimulator();</span>
<span class="nc" id="L217">    }</span>


    private void enablePortConnections() {

        // If no output port, this node cannot start a connection
<span class="nc bnc" id="L223" title="All 2 branches missed.">        if (outputPort == null) {</span>
<span class="nc" id="L224">            return;</span>
        }

<span class="nc" id="L227">        outputPort.setOnMouseReleased(e -&gt; {</span>

<span class="nc" id="L229">            double mouseX = e.getSceneX();</span>
<span class="nc" id="L230">            double mouseY = e.getSceneY();</span>

<span class="nc" id="L232">            Pane parent = (Pane) getParent();</span>
<span class="nc" id="L233">            List&lt;NodeView&gt; targets = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L235" title="All 2 branches missed.">            for (var nodent : parent.getChildren()) {</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">                if (nodent instanceof NodeView other</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">                    &amp;&amp; other != this</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">                    &amp;&amp; other.inputPort != null</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">                    &amp;&amp; other.isMouseNearInput(mouseX, mouseY, 50)) {</span>

<span class="nc" id="L241">                    targets.add(other);</span>
                }
            }

<span class="nc bnc" id="L245" title="All 2 branches missed.">            for (NodeView other : targets) {</span>

<span class="nc" id="L247">                Connection connection = new Connection(</span>
<span class="nc" id="L248">                        node.getId(),</span>
<span class="nc" id="L249">                        true,   </span>
<span class="nc" id="L250">                        other.node.getId(),</span>
<span class="nc" id="L251">                        true</span>
                );

<span class="nc" id="L254">                project.addConnection(connection);</span>

<span class="nc" id="L256">                ConnectionView connectionView = new ConnectionView(outputPort, other.getInputPort(), connection, project);</span>

<span class="nc" id="L258">                parent.getChildren().add(connectionView);</span>
<span class="nc" id="L259">                connectionView.toBack();</span>
            }
<span class="nc" id="L261">        });</span>
<span class="nc" id="L262">    }</span>

    public boolean isMouseNearInput(double sceneX, double sceneY, double radius) {
<span class="nc bnc" id="L265" title="All 2 branches missed.">        if (inputPort == null) {</span>
<span class="nc" id="L266">            return false;</span>
        }

<span class="nc" id="L269">        var bounds = inputPort.localToScene(inputPort.getBoundsInLocal());</span>
<span class="nc" id="L270">        double centerX = (bounds.getMinX() + bounds.getMaxX()) / 2;</span>
<span class="nc" id="L271">        double centerY = (bounds.getMinY() + bounds.getMaxY()) / 2;</span>

<span class="nc" id="L273">        double dx = sceneX - centerX;</span>
<span class="nc" id="L274">        double dy = sceneY - centerY;</span>

<span class="nc bnc" id="L276" title="All 2 branches missed.">        return Math.sqrt(dx * dx + dy * dy) &lt;= radius;</span>
    }

    public void setInfo(String text) {
<span class="nc" id="L280">        infoArea.getChildren().clear();</span>

<span class="nc" id="L282">        Label label = new Label(text);</span>
<span class="nc" id="L283">        label.getStyleClass().add(&quot;node-info&quot;);</span>

<span class="nc" id="L285">        infoArea.getChildren().add(label);</span>
<span class="nc" id="L286">    }</span>

    public void applyRarityColor(String rarity) {
        String color;

<span class="nc bnc" id="L291" title="All 5 branches missed.">        switch (rarity.trim().toLowerCase()) {</span>
<span class="nc" id="L292">            case &quot;normal&quot; -&gt; color = &quot;#3a3a3a&quot;;</span>
<span class="nc" id="L293">            case &quot;magic&quot;  -&gt; color = &quot;#4b6cff&quot;;</span>
<span class="nc" id="L294">            case &quot;rare&quot;   -&gt; color = &quot;#b8860b&quot;;</span>
<span class="nc" id="L295">            case &quot;basecurrency&quot; -&gt; color = &quot;#412e00&quot;;</span>
<span class="nc" id="L296">            default       -&gt; color = &quot;#ff0000&quot;;</span>
        }

<span class="nc" id="L299">        header.setStyle(</span>
<span class="nc" id="L300">            &quot;-fx-background-color: &quot; + color + &quot;;&quot; +</span>
            &quot;-fx-background-radius: 12 12 12 12;&quot; +
            &quot;-fx-background-insets: 0;&quot; +
            &quot;-fx-padding: 6 10;&quot;
        );
<span class="nc" id="L305">    }</span>

    
    

    public LoadedItem execute(LoadedItem item) {
<span class="nc" id="L311">        return item;</span>
    }


    public Circle getInputPort() {
<span class="nc" id="L316">        return inputPort;</span>
    }

    public Circle getOutputPort() {
<span class="nc" id="L320">        return outputPort;</span>
    }

    public Node getNode() {
<span class="nc" id="L324">        return node;</span>
    }

    public void setTitle(String title) {
<span class="nc" id="L328">        titleLabel.setText(title);</span>
<span class="nc" id="L329">    }</span>

    public void refresh() {
<span class="nc" id="L332">        body.getChildren().setAll(buildContent());</span>
<span class="nc" id="L333">    }</span>


    protected Project getProject() {
<span class="nc" id="L337">        return project;</span>
    }

    protected Label getTitleLabel() {
<span class="nc" id="L341">        return titleLabel;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>